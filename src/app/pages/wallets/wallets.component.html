<div class="container">
  <!-- Main Content -->
  <div class="main">
    <!-- Navigation and Title -->
    <app-page-title title="Mis billeteras" (back)="goBack()"></app-page-title>

    <!-- Total Balance Card -->
    <div class="total-balance-card">
      <div class="balance-label">Total:</div>
      <div class="balance-amount">{{ formatCurrency(totalBalanceLoaded) }}</div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="action-btn" (click)="openTransferHistory()">
        <div class="action-icon">
          <i class="mdi mdi-refresh"></i>
        </div>
        <span class="action-text">Historial de transferencias</span>
      </button>

      <button class="action-btn" (click)="openNewTransfer()">
        <div class="action-icon">
          <i class="mdi mdi-swap-horizontal"></i>
        </div>
        <span class="action-text">Nueva transferencia</span>
      </button>
    </div>

    <!-- Wallets List -->
    <div class="wallets-list">
      <div class="wallet-item" *ngFor="let wallet of billeteras" (click)="openWalletPopup(wallet)" style="cursor: pointer">
        <div class="wallet-icon" [style.background-color]="wallet.color">
          <i [class]="wallet.icon"></i>
        </div>
        <div class="wallet-info">
          <div class="wallet-name">{{ wallet.nombre }}</div>
          <div class="wallet-subtitle">
            <span class="wallet-type">{{ wallet.type }}</span>
            <span class="wallet-dot" *ngIf="wallet.isDefault">•</span>
            <span class="wallet-default" *ngIf="wallet.isDefault">Predeterminada</span>
          </div>
        </div>
        <div class="wallet-meta">
          <div class="wallet-balance">{{ formatCurrency(wallet.balance) }}</div>
          <i class="mdi mdi-chevron-right"></i>
        </div>
      </div>
    </div>

    <!-- Add Account Button -->
    <button class="add-account-btn" (click)="addAccount()">
      <i class="mdi mdi-plus"></i>
      <span>Agregar Billetera</span>
    </button>
  </div>

  <!-- Modal: Agregar cuenta -->
  <app-add-account-modal *ngIf="showAddAccountModal" (closeModal)="closeAddAccountModal()"
    (saveAccount)="saveAccount($event)">
  </app-add-account-modal>

  <!-- Popup: Detalles de billetera -->
  <div class="wallet-popup-overlay" *ngIf="showWalletPopup" (click)="closeWalletPopup()">
    <div class="wallet-popup" (click)="$event.stopPropagation()">
      <!-- Header del popup -->
      <div class="popup-header">
        <div class="popup-title">
          <div class="popup-wallet-icon" [style.background-color]="selectedWallet?.color">
            <i [class]="selectedWallet?.icon"></i>
          </div>
          <div class="popup-wallet-info">
            <h3 class="popup-wallet-name">{{ selectedWallet?.nombre }}</h3>
            <p class="popup-wallet-type">{{ selectedWallet?.type }}</p>
          </div>
        </div>
        <button class="popup-close-btn" (click)="closeWalletPopup()">
          <i class="mdi mdi-close"></i>
        </button>
      </div>

      <!-- Contenido del popup -->
      <div class="popup-content">
        <!-- Balance principal -->
        <div class="popup-balance-section">
          <div class="popup-balance-label">Balance actual</div>
          <div class="popup-balance-amount">{{ formatCurrency(selectedWallet?.balance || 0) }}</div>
        </div>

        <div class="popup-balance-grid">
          <!-- Ingresos históricos -->
          <div class="popup-balance-section small">
            <div class="popup-balance-label">Ingresos históricos</div>
            <div class="popup-balance-amount">{{ formatCurrency(selectedWallet?.ingresoHistorico || 0) }}</div>
          </div>

          <!-- Gastos históricos -->
          <div class="popup-balance-section small">
            <div class="popup-balance-label">Gastos históricos</div>
            <div class="popup-balance-amount">{{ formatCurrency(selectedWallet?.gastoHistorico || 0) }}</div>
          </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="popup-actions">
          <button class="popup-action-btn" (click)="openWalletTransfer()">
            <div class="popup-action-icon">
              <i class="mdi mdi-swap-horizontal"></i>
            </div>
            <span>Nueva transferencia</span>
          </button>

          <button class="popup-action-btn" (click)="openWalletHistory()">
            <div class="popup-action-icon">
              <i class="mdi mdi-history"></i>
            </div>
            <span>Ver transferencias</span>
          </button>
        </div>

        <!-- Información adicional -->
        <div class="popup-details">
          <div class="popup-detail-item">
            <span class="detail-label">Tipo de cuenta:</span>
            <span class="detail-value">{{ getWalletTypeLabel(selectedWallet?.type) }}</span>
          </div>
          <div class="popup-detail-item" *ngIf="selectedWallet?.isDefault">
            <span class="detail-label">Estado:</span>
            <span class="detail-value default-badge">Predeterminada</span>
          </div>
          <div class="popup-detail-item">
            <span class="detail-label">Última actualización:</span>
            <span class="detail-value">{{ getLastUpdate() }}</span>
          </div>
        </div>

        <!-- Botones de acción principales -->
        <div class="popup-main-actions">
          <button class="popup-main-btn primary" (click)="setAsDefault()" *ngIf="!selectedWallet?.isDefault">
            <i class="mdi mdi-star"></i>
            Establecer como predeterminada
          </button>
          <button class="popup-main-btn secondary" (click)="editWallet()">
            <i class="mdi mdi-pencil"></i>
            Editar billetera
          </button>
          <button class="popup-main-btn danger" (click)="deleteWallet()">
            <i class="mdi mdi-delete"></i>
            Eliminar billetera
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Transferencia -->
<div class="wallet-popup-overlay" *ngIf="showTransferModal" (click)="closeTransferModal()">
  <div class="wallet-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <div class="popup-title">
        <div class="popup-wallet-icon" [style.background-color]="selectedWallet?.color || '#3b3b58'">
          <i class="mdi mdi-swap-horizontal"></i>
        </div>
        <div class="popup-wallet-info">
          <h3 class="popup-wallet-name">Nueva transferencia</h3>
          <p class="popup-wallet-type">Completa los datos de la transferencia</p>
        </div>
      </div>
      <button class="popup-close-btn" (click)="closeTransferModal()">
        <i class="mdi mdi-close"></i>
      </button>
    </div>

    <div class="popup-content">
      <div class="popup-details">
        <div class="popup-detail-item">
          <span class="detail-label">Banco origen</span>
          <span class="detail-value">
            <mat-select
              class="form-input"
              [(ngModel)]="transferForm.originId"
              placeholder="Banco origen"
            >
              <mat-option [value]="''" disabled>Seleccionar</mat-option>
              <mat-option *ngFor="let w of billeteras" [value]="w.id">{{ w.nombre }}</mat-option>
            </mat-select>
          </span>
        </div>
        <div class="popup-detail-item">
          <span class="detail-label">Monto a transferir</span>
          <span class="detail-value">
            <input class="form-input" type="number" min="0" [(ngModel)]="transferForm.originAmount" placeholder="0" />
          </span>
        </div>
        <div class="popup-detail-item">
          <span class="detail-label">Banco destino</span>
          <span class="detail-value">
            <mat-select
              class="form-input"
              [(ngModel)]="transferForm.destinationId"
              placeholder="Banco destino"
            >
              <mat-option [value]="''" disabled>Seleccionar</mat-option>
              <mat-option *ngFor="let w of billeteras" [value]="w.id">{{ w.nombre }}</mat-option>
            </mat-select>
          </span>
        </div>
        
      </div>

      <div class="popup-main-actions">
        <button class="popup-main-btn primary" (click)="submitTransfer()">
          <i class="mdi mdi-check"></i>
          Confirmar transferencia
        </button>
        <button class="popup-main-btn danger" (click)="closeTransferModal()">
          <i class="mdi mdi-close"></i>
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Historial de Transferencias -->
<div class="wallet-popup-overlay" *ngIf="showTransferHistory" (click)="closeTransferHistory()">
  <div class="wallet-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <div class="popup-title">
        <div class="popup-wallet-icon" [style.background-color]="selectedWallet?.color || '#3b3b58'">
          <i class="mdi mdi-history"></i>
        </div>
        <div class="popup-wallet-info">
          <h3 class="popup-wallet-name">Historial de transferencias</h3>
          <p class="popup-wallet-type">Últimas transferencias realizadas</p>
        </div>
      </div>
      <button class="popup-close-btn" (click)="closeTransferHistory()">
        <i class="mdi mdi-close"></i>
      </button>
    </div>

    <div class="popup-content">
      <div class="popup-details" *ngIf="billeteras && billeteras.length">
        <div class="popup-detail-item" *ngFor="let w of billeteras | slice:0:5">
          <span class="detail-label">{{ getLastUpdate() }}</span>
          <span class="detail-value">{{ w.nombre }} → {{ billeteras[0].nombre }} — {{ formatCurrency(w.balance || 0) }}</span>
        </div>
      </div>

      <div class="popup-main-actions">
        <button class="popup-main-btn secondary" (click)="closeTransferHistory()">
          <i class="mdi mdi-close"></i>
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>
