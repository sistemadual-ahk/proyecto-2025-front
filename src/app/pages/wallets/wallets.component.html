<div class="container">
  <!-- Main Content -->
  <div class="main">
    <!-- Navigation and Title -->
    <app-page-title title="Mis billeteras" (back)="goBack()"></app-page-title>

    <!-- Total Balance Card -->
    <div class="total-balance-card">
      <button class="toggle-balance-btn" (click)="toggleBalances()">
        <i class="mdi" [ngClass]="hideBalances ? 'mdi-eye-off' : 'mdi-eye'"></i>
      </button>
      <div class="balance-header">
        <div class="balance-label">Total:</div>
      </div>
      <div class="balance-amount">
        {{ hideBalances ? '****' : formatCurrency(totalBalanceARS, 'ARS') }}
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      <button class="action-btn" (click)="openTransferHistory()">
        <div class="action-icon">
          <i class="mdi mdi-refresh"></i>
        </div>
        <span class="action-text">Historial de transferencias</span>
      </button>

      <button class="action-btn" (click)="openNewTransfer()">
        <div class="action-icon">
          <i class="mdi mdi-swap-horizontal"></i>
        </div>
        <span class="action-text">Nueva transferencia</span>
      </button>
    </div>

    <!-- Wallets List -->
    <div class="wallets-list">
      <div class="wallet-item" *ngFor="let wallet of billeteras" (click)="openWalletPopup(wallet)" style="cursor: pointer">
        <div class="wallet-icon" [style.background]="wallet.color">
          <i [class]="wallet.icon"></i>
        </div>
        <div class="wallet-info">
          <div class="wallet-name">{{ wallet.nombre }}</div>
          <div class="wallet-subtitle">
            <span class="wallet-type">{{ wallet.type }}</span>
          </div>
        </div>
        <div class="wallet-meta">
          <div class="wallet-meta-text">
            <div class="wallet-balance">
              {{ hideBalances ? '****' : formatCurrency(wallet.balance, getWalletCurrency(wallet)) }}
            </div>
            <div class="wallet-currency">{{ getWalletCurrency(wallet) }}</div>
          </div>
          <i class="mdi mdi-chevron-right"></i>
        </div>
      </div>
    </div>

    <!-- Add Account Button -->
    <button class="add-account-btn" (click)="addAccount()">
      <i class="mdi mdi-plus"></i>
      <span>Agregar Billetera</span>
    </button>
  </div>

  <!-- Modal: Agregar cuenta -->
  <app-add-account-modal
    *ngIf="showAddAccountModal"
    [walletToEdit]="walletToEdit"
    [mode]="addAccountMode"
    (closeModal)="closeAddAccountModal()"
    (saveAccount)="handleAccountSaved($event)"
  >
  </app-add-account-modal>

  <!-- Popup: Detalles de billetera -->
  <div class="wallet-popup-overlay" *ngIf="showWalletPopup" (click)="closeWalletPopup()">
    <div class="wallet-popup" (click)="$event.stopPropagation()">
      <!-- Header del popup -->
      <div class="popup-header">
        <div class="popup-title">
          <div class="popup-wallet-icon" [style.background]="selectedWallet?.color">
            <i [class]="selectedWallet?.icon"></i>
          </div>
          <div class="popup-wallet-info">
            <h3 class="popup-wallet-name">{{ selectedWallet?.nombre }}</h3>
            <p class="popup-wallet-type">{{ selectedWallet?.type }}</p>
          </div>
        </div>
        <button class="popup-close-btn" (click)="closeWalletPopup()">
          <i class="mdi mdi-close"></i>
        </button>
      <!-- Contenido del popup -->
      <div class="popup-content">
        <!-- Balance principal -->
        <div class="popup-balance-section">
          <div class="popup-balance-label">Balance actual</div>
          <div class="popup-balance-amount">
            {{ hideBalances ? '****' : formatCurrency(selectedWallet?.balance || 0) }}
          </div>
        </div>

        <div class="popup-balance-grid">
          <!-- Ingresos históricos -->
          <div class="popup-balance-section small">
            <div class="popup-balance-label">Ingresos históricos</div>
            <div class="popup-balance-amount">
              {{ hideBalances ? '****' : formatCurrency(selectedWallet?.ingresoHistorico || 0) }}
            </div>
          </div>

          <!-- Gastos históricos -->
          <div class="popup-balance-section small">
            <div class="popup-balance-label">Gastos históricos</div>
            <div class="popup-balance-amount">
              {{ hideBalances ? '****' : formatCurrency(selectedWallet?.gastoHistorico || 0) }}
            </div>
          </div>
        </div>

        <!-- Acciones rápidas -->
        <div class="popup-actions">
          <button class="popup-action-btn" (click)="openWalletTransfer()">
            <div class="popup-action-icon">
              <i class="mdi mdi-swap-horizontal"></i>
            </div>
            <span>Nueva transferencia</span>
          </button>

          <button class="popup-action-btn" (click)="openWalletHistory()">
            <div class="popup-action-icon">
              <i class="mdi mdi-history"></i>
            </div>
            <span>Ver transferencias</span>
          </button>
        </div>

        <!-- Información adicional -->
        <div class="popup-details">
          <div class="popup-detail-item">
            <span class="detail-label">Tipo de cuenta:</span>
            <span class="detail-value">{{ getWalletTypeLabel(selectedWallet?.type) }}</span>
          </div>
          <div class="popup-detail-item" *ngIf="selectedWallet?.isDefault">
            <span class="detail-label">Estado:</span>
            <span class="detail-value default-badge">Predeterminada</span>
          </div>
          <div class="popup-detail-item">
            <span class="detail-label">última actualización:</span>
            <span class="detail-value">{{ getLastUpdate() }}</span>
          </div>
        </div>

        <!-- Botones de acción principales -->
        <div class="popup-main-actions">
          <button class="popup-main-btn primary" (click)="setAsDefault()" *ngIf="!selectedWallet?.isDefault">
            <i class="mdi mdi-star"></i>
            Establecer como predeterminada
          </button>
          <button class="popup-main-btn secondary" (click)="editWallet()">
            <i class="mdi mdi-pencil"></i>
            Editar billetera
          </button>
          <button class="popup-main-btn danger" (click)="deleteWallet()">
            <i class="mdi mdi-delete"></i>
            Eliminar billetera
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Editar billetera -->
<div class="edit-wallet-overlay" *ngIf="showEditWalletModal" (click)="closeEditWalletModal()">
  <form
    class="edit-wallet-modal"
    #walletEditForm="ngForm"
    (ngSubmit)="submitWalletEdit()"
    (click)="$event.stopPropagation()"
  >
    <div class="edit-wallet-header">
      <button class="icon-btn" type="button" (click)="closeEditWalletModal()">
        <i class="mdi mdi-close"></i>
      </button>

      <div class="edit-wallet-title">
        <h2>Editar billetera</h2>
        <p>Actualizar los datos principales</p>
      </div>

      <button
        class="icon-btn save-btn"
        type="submit"
        [disabled]="walletEditForm.invalid || isSavingWallet"
      >
        <i class="mdi" [ngClass]="isSavingWallet ? 'mdi-loading mdi-spin' : 'mdi-check'"></i>
      </button>
    </div>

    <div class="edit-wallet-body">
      <div class="transaction-toggle">
        <button
          type="button"
          class="toggle-btn bank-btn"
          [class.active]="editWalletForm.type === 'bank'"
          (click)="setEditWalletType('bank')"
        >
          <i class="mdi mdi-bank"></i> Banco
        </button>
        <button
          type="button"
          class="toggle-btn digital-btn"
          [class.active]="editWalletForm.type === 'digital'"
          (click)="setEditWalletType('digital')"
        >
          <i class="mdi mdi-credit-card"></i> Digital
        </button>
        <button
          type="button"
          class="toggle-btn cash-btn"
          [class.active]="editWalletForm.type === 'cash'"
          (click)="setEditWalletType('cash')"
        >
          <i class="mdi mdi-cash-multiple"></i> Efectivo
        </button>
      </div>

      <div class="edit-wallet-form">
        <div class="form-group">
          <label class="form-label" for="walletName">Nombre de la billetera</label>
          <input
            type="text"
            class="form-input"
            id="walletName"
            name="walletName"
            [(ngModel)]="editWalletForm.nombre"
            required
            placeholder="Ej: Cuenta principal"
          />
        </div>

        <div class="form-group" *ngIf="editWalletForm.type !== 'cash'">
          <label class="form-label" for="walletProvider">Proveedor / Banco</label>
          <div class="input-with-icon">
            <mat-select
              class="form-input"
              id="walletProvider"
              name="walletProvider"
              [(ngModel)]="editWalletForm.proveedor"
              placeholder="Seleccionar proveedor"
              required
            >
              <mat-option [value]="''" disabled>Seleccionar proveedor</mat-option>
              <mat-option *ngFor="let provider of editProviders" [value]="provider">
                {{ provider }}
              </mat-option>
            </mat-select>
            <i class="mdi mdi-chevron-down"></i>
          </div>
        </div>

        <div class="form-group amount-group">
          <label class="form-label" for="walletBalance">Balance actual</label>
          <div class="input-with-icon">
            <input
              type="text"
              inputmode="decimal"
              appNumberFormat
              class="form-input"
              id="walletBalance"
              name="walletBalance"
              [(ngModel)]="editWalletForm.balance"
              required
              placeholder="Ingrese monto"
            />
            <i class="mdi mdi-currency-usd"></i>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Color de la billetera</label>
          <div class="color-options">
            <div
              class="color-circle"
              *ngFor="let option of colorOptions"
              [style.background]="option.gradient"
              [class.selected]="editWalletForm.color === option.gradient"
              (click)="selectEditWalletColor(option.gradient)"
            >
              <i class="mdi mdi-check" *ngIf="editWalletForm.color === option.gradient"></i>
            </div>
          </div>
        </div>

        <div class="error-message" *ngIf="walletEditForm.submitted && walletEditForm.invalid">
          Completa todos los campos obligatorios para guardar los cambios.
        </div>
      </div>
    </div>

    <div class="edit-wallet-actions">
      <button
        class="popup-main-btn primary"
        type="submit"
        [disabled]="walletEditForm.invalid || isSavingWallet"
      >
        <i class="mdi mdi-content-save"></i>
        Guardar cambios
      </button>
      <button class="popup-main-btn danger" type="button" (click)="closeEditWalletModal()">
        <i class="mdi mdi-close"></i>
        Cancelar
      </button>
    </div>
  </form>
</div>

<!-- Modal de Transferencia -->
<div class="wallet-popup-overlay" *ngIf="showTransferModal" (click)="closeTransferModal()">
  <div class="wallet-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <div class="popup-title">
        <div class="popup-wallet-icon" [style.background]="selectedWallet?.color || '#3b3b58'">
          <i class="mdi mdi-swap-horizontal"></i>
        </div>
        <div class="popup-wallet-info">
          <h3 class="popup-wallet-name">Nueva transferencia</h3>
          <p class="popup-wallet-type">Completa los datos de la transferencia</p>
        </div>
      </div>
      <button class="popup-close-btn" (click)="closeTransferModal()">
        <i class="mdi mdi-close"></i>
      </button>
    </div>

    <div class="popup-content">
      <div class="popup-details">
        <div class="popup-detail-item">
          <span class="detail-label">Billetera origen</span>
          <span class="detail-value">
            <mat-select
              class="form-input"
              [(ngModel)]="transferForm.originId"
              placeholder="Billetera origen"
            >
              <mat-option [value]="''" disabled>Seleccionar</mat-option>
              <mat-option *ngFor="let w of getFilteredTransferWallets('origin')" [value]="w.id">
                {{ w.nombre }}
              </mat-option>
            </mat-select>
          </span>
        </div>
        <div class="popup-detail-item">
          <span class="detail-label">Monto a transferir</span>
          <span class="detail-value">
            <input
              class="form-input"
              type="text"
              inputmode="decimal"
              appNumberFormat
              [(ngModel)]="transferForm.originAmount"
              placeholder="Ingrese monto"
            />
          </span>
        </div>
        <div class="popup-detail-item">
          <span class="detail-label">Billetera destino</span>
          <span class="detail-value">
            <mat-select
              class="form-input"
              [(ngModel)]="transferForm.destinationId"
              placeholder="Billetera destino"
            >
              <mat-option [value]="''" disabled>Seleccionar</mat-option>
              <mat-option *ngFor="let w of getFilteredTransferWallets('destination')" [value]="w.id">
                {{ w.nombre }}
              </mat-option>
            </mat-select>
          </span>
        </div>
        
      </div>

      <div class="popup-main-actions">
        <button class="popup-main-btn primary" (click)="submitTransfer()">
          <i class="mdi mdi-check"></i>
          Confirmar transferencia
        </button>
        <button class="popup-main-btn danger" (click)="closeTransferModal()">
          <i class="mdi mdi-close"></i>
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Historial de Transferencias -->
<div class="wallet-popup-overlay" *ngIf="showTransferHistory" (click)="closeTransferHistory()">
  <div class="wallet-popup" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <div class="popup-title">
        <div class="popup-wallet-icon" [style.background]="selectedWallet?.color || '#3b3b58'">
          <i class="mdi mdi-history"></i>
        </div>
        <div class="popup-wallet-info">
          <h3 class="popup-wallet-name">Historial de transferencias</h3>
          <p class="popup-wallet-type">Últimas transferencias entre tus billeteras</p>
        </div>
      </div>
      <button class="popup-close-btn" (click)="closeTransferHistory()">
        <i class="mdi mdi-close"></i>
      </button>
    </div>

      <div class="popup-content">
        <div class="transfer-list" *ngIf="transferHistoryView.length; else noTransfers">
          <div class="transfer-row" *ngFor="let t of transferHistoryView">
          <div class="transfer-main">
            <div class="transfer-title">
              <span class="from">{{ t.from }}</span>
              <span class="arrow">→</span>
              <span class="to">{{ t.to }}</span>
            </div>
            <div class="transfer-meta">
              <span class="status" [class.completed]="t.status === 'Completada'">{{ t.status }}</span>
              <span class="date">{{ t.date }}</span>
            </div>
          </div>
          <div class="transfer-amount">
            {{ formatCurrency(t.amount, t.currency) }}
          </div>
        </div>
      </div>
      <ng-template #noTransfers>
        <div class="empty-state">
          <i class="mdi mdi-transfer"></i>
          <p>No hay transferencias registradas aún.</p>
        </div>
      </ng-template>

      <div class="popup-main-actions">
        <button class="popup-main-btn secondary" (click)="closeTransferHistory()">
          <i class="mdi mdi-close"></i>
          Cerrar
        </button>
      </div>
    </div>
  </div>
</div>

