<div class="container">
  <!-- Main Content -->
  <div class="main">
    <!-- Título de la página -->
    <app-page-title title="Actividad" (back)="goBack()"></app-page-title>

    <!-- Barra de búsqueda -->
    <div class="search-section">
      <div class="search-bar">
        <i class="mdi mdi-magnify search-icon"></i>
        <input type="text" placeholder="Buscar" class="search-input" [(ngModel)]="searchTerm" (input)="onSearch()"/>
      </div>
      
      <!-- Filtros -->
      <div class="filters-container">
        <!-- Filtro Tipo -->
        <div class="filter-group type-filter">
          <button 
            class="filter-btn" 
            [class.active]="filterType === 'all'" 
            (click)="filterType = 'all'; onFilterChange()">
            Todos
          </button>
          <button 
            class="filter-btn income-btn" 
            [class.active]="filterType === 'income'" 
            (click)="filterType = 'income'; onFilterChange()">
            Ingresos
          </button>
          <button 
            class="filter-btn expense-btn" 
            [class.active]="filterType === 'expense'" 
            (click)="filterType = 'expense'; onFilterChange()">
            Gastos
          </button>
        </div>

        <div class="filter-row">
          <!-- Filtro Tiempo -->
          <div class="filter-group select-filter">
            <mat-select [(ngModel)]="filterTime" (selectionChange)="onFilterChange()" class="custom-mat-select" panelClass="custom-select-panel">
              <mat-option value="historic">Histórico</mat-option>
              <mat-option value="month">Último mes</mat-option>
              <mat-option value="week">Última semana</mat-option>
            </mat-select>
          </div>

          <!-- Filtro Billetera -->
          <div class="filter-group select-filter">
            <mat-select [(ngModel)]="filterWalletId" (selectionChange)="onFilterChange()" class="custom-mat-select" panelClass="custom-select-panel">
              <mat-option value="all">Todas las billeteras</mat-option>
              <mat-option *ngFor="let wallet of wallets" [value]="wallet.id">
                {{ wallet.nombre }}
              </mat-option>
            </mat-select>
          </div>
        </div>
      </div>
    </div>

    <!-- Lista de operaciones agrupados por fecha -->
    <div class="transactions-container">
      <div class="date-group" *ngFor="let group of groupedOperaciones">
        <div class="date-header">{{ group.date }}</div>

        <div class="transactions-list">
          <div class="transaction-item" *ngFor="let operacion of group.operaciones" (click)="openEditOperationModal(operacion)">
            <!-- Ícono de categoría -->
            <div
              class="category-icon"
              [style.background-color]="operacion.categoriaColor || '#A8A8A8'"
            >
              <i [class]="operacion.categoriaIcono || 'mdi-dots-horizontal'"></i>
            </div>

            <!-- Información del operación -->
            <div class="transaction-info">
              <div class="transaction-main">
                <h3 class="transaction-description">
                  {{ operacion.descripcion }}
                                  </h3>
                <p class="transaction-category">{{ operacion.categoriaNombre || 'Sin categor�a' }}</p>
                <p class="transaction-time">{{ formatearFecha(operacion.fecha.toString()) }}</p>
              </div>

              <div class="transaction-amount" [class.income]="operacion.tipo === 'Ingreso' || operacion.tipo === 'income'">
                <span class="amount-sign">{{ operacion.tipo === 'Ingreso' || operacion.tipo === 'income' ? '+' : '-' }}</span>
                ${{ operacion.monto.toLocaleString() }}
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Botón Cargar más -->
      <div class="load-more-container" *ngIf="hasMoreItems && groupedOperaciones.length > 0">
        <button class="load-more-btn" (click)="loadMore()" [disabled]="isLoadingMore">
          <span *ngIf="!isLoadingMore">Cargar más movimientos</span>
          <div class="loader" *ngIf="isLoadingMore"></div>
        </button>
      </div>
    </div>

    <!-- Estado vacío  -->
    <div class="empty-state" *ngIf="groupedOperaciones.length === 0">
      <div class="empty-icon">
        <i class="mdi mdi-receipt-text-outline"></i>
      </div>
      <h3>No hay operaciones</h3>
      <p>Aún no has registrado ningun gasto. ¡Comienza a trackear tus gastos!</p>
    </div>
  </div>

  <!-- Modal de edición -->
  <edit-operation-modal
    *ngIf="showEditModal && selectedOperacion"
    [operacion]="selectedOperacion"
    (closeModal)="closeEditModal()"
    (operationUpdated)="onOperationUpdated()"
    (operationDeleted)="onOperationDeleted()"
  >
  </edit-operation-modal>
</div>

